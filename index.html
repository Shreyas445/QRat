<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student QR</title>

<!-- QR GENERATE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- QR SCAN -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    height: 100vh;
    background: #0b1220;
    font-family: -apple-system, BlinkMacSystemFont, system-ui;
}

.overlay {
    position: fixed;
    inset: 0;
    background: rgba(8,12,28,0.65);
    backdrop-filter: blur(12px);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal {
    width: 92%;
    max-width: 360px;
    background: #0e1626;
    border-radius: 12px;
    padding: 14px;
    color: white;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 17px;
    font-weight: 500;
    margin-bottom: 12px;
}

.close {
    font-size: 20px;
    cursor: pointer;
}

.qr-box {
    background: white;
    padding: 18px;
    border-radius: 6px;
    display: flex;
    justify-content: center;
}

.qr-text {
    text-align: center;
    font-size: 12.5px;
    margin-top: 8px;
    color: #b8c0ff;
    word-break: break-word;
}

input {
    width: 100%;
    padding: 11px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
    margin-bottom: 10px;
}

button {
    width: 100%;
    padding: 11px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
    cursor: pointer;
}

.primary { background: #2f6bff; color: white; }
.secondary { background: #2a2f45; color: #dcdcff; margin-top: 8px; }
.danger { background: #ff5c5c; color: white; margin-top: 8px; }

.center-text {
    text-align: center;
    font-size: 14px;
    margin: 10px 0;
}
</style>
</head>

<body>

<div class="overlay">
    <div class="modal" id="app"></div>
</div>

<!-- hidden container for image QR decoding -->
<div id="img-reader" style="display:none;"></div>

<script>
const app = document.getElementById("app");
let cameraScanner = null;

/* ---------- UTIL ---------- */
function today() {
    return new Date().toISOString().split("T")[0];
}

/* ---------- QR DISPLAY ---------- */
function showQR(studentNo) {
    stopScanner();

    app.innerHTML = `
        <div class="header">
            <span>QRCode</span>
            <span class="close" onclick="showClearConfirm()">✕</span>
        </div>

        <div class="qr-box">
            <div id="qrcode"></div>
        </div>

        <div class="qr-text">${studentNo}/${today()}/student</div>
    `;

    new QRCode(document.getElementById("qrcode"), {
        text: `${studentNo}/${today()}/student`,
        width: 210,
        height: 210,
        correctLevel: QRCode.CorrectLevel.H
    });
}

/* ---------- REGISTER PAGE ---------- */
function showRegister() {
    stopScanner();

    app.innerHTML = `
        <div class="header">
            <span>Register Student</span>
        </div>

        <input type="number" id="studentInput" placeholder="Enter student number">
        <button class="primary" onclick="registerManual()">Register</button>
        <button class="secondary" onclick="openScanner()">Register with QR</button>
    `;
}

/* ---------- CAMERA SCANNER ---------- */
function openScanner() {
    app.innerHTML = `
        <div class="header">
            <span>Scan QR</span>
            <span class="close" onclick="showRegister()">✕</span>
        </div>

        <div id="reader" style="width:100%;"></div>

        <div class="center-text">OR</div>

        <input type="file" accept="image/*" onchange="scanImage(event)">
    `;

    cameraScanner = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(cameras => {
        if (!cameras.length) {
            alert("No camera found");
            return;
        }

        const backCam = cameras.find(c =>
            c.label.toLowerCase().includes("back")
        ) || cameras[0];

        cameraScanner.start(
            backCam.id,
            { fps: 10, qrbox: 220 },
            onScanSuccess,
            () => {}
        );
    }).catch(err => {
        alert("Camera permission denied");
        console.error(err);
    });
}

/* ---------- IMAGE SCAN (FIXED) ---------- */
function scanImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    stopScanner();

    const imgScanner = new Html5Qrcode("img-reader");

    imgScanner.scanFile(file, false)
        .then(text => {
            imgScanner.clear();
            onScanSuccess(text);
        })
        .catch(err => {
            imgScanner.clear();
            alert("Invalid QR image");
            console.error(err);
        });
}

/* ---------- QR RESULT ---------- */
function onScanSuccess(decodedText) {
    stopScanner();

    const studentNo = decodedText.split("/")[0];
    if (!studentNo) {
        alert("Invalid QR format");
        return;
    }

    localStorage.setItem("studentNumber", studentNo);
    showQR(studentNo);
}

/* ---------- CLEAR CONFIRM ---------- */
function showClearConfirm() {
    stopScanner();

    app.innerHTML = `
        <div class="header">
            <span>Clear Data</span>
        </div>

        <div class="center-text">Clear saved student data?</div>

        <button class="danger" onclick="clearStorage()">Yes, Clear</button>
        <button class="secondary" onclick="goBack()">Cancel</button>
    `;
}

/* ---------- ACTIONS ---------- */
function registerManual() {
    const val = document.getElementById("studentInput").value.trim();
    if (!val) {
        alert("Enter student number");
        return;
    }
    localStorage.setItem("studentNumber", val);
    showQR(val);
}

function clearStorage() {
    localStorage.removeItem("studentNumber");
    showRegister();
}

function goBack() {
    const s = localStorage.getItem("studentNumber");
    if (s) showQR(s);
}

function stopScanner() {
    if (cameraScanner) {
        cameraScanner.stop().catch(() => {});
        cameraScanner.clear();
        cameraScanner = null;
    }
}

/* ---------- INIT ---------- */
const saved = localStorage.getItem("studentNumber");
saved ? showQR(saved) : showRegister();
</script>

</body>
</html>
