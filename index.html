<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Student QR Collection</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  height: 100vh;
  background: #0b1220;
  font-family: system-ui;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal {
  width: 92%;
  max-width: 360px;
  background: linear-gradient(180deg,#0f1a2e,#0c1424);
  border-radius: 16px;
  padding: 18px;
  color: white;
}

.header {
  font-size: 18px;
  margin-bottom: 14px;
}

.close {
  cursor: pointer;
  font-size: 20px;
}

input[type="text"] {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  margin-bottom: 12px;
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  cursor: pointer;
}

.primary { background: #3a6cff; color: white; }
.secondary { background: #2a2f45; color: white; }
.tirnery { background: #5c4bde; color: white; }
.danger { background: #ff5c5c; color: white; }

.divider {
  text-align: center;
  color: #7f89c9;
  font-size: 13px;
  margin: 10px 0;
}

.row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

.row button {
  flex: 1;
}

.center {
  text-align: center;
}

.qr-box {
  background: white;
  padding: 16px;
  border-radius: 10px;
  display: flex;
  justify-content: center;
}

.qr-text {
  text-align: center;
  margin-top: 10px;
  font-size: 13px;
  color: #b8c0ff;
}

/* New Styles for List and Checkbox */
.checkbox-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-size: 14px;
}

.checkbox-row input {
  width: auto;
  margin: 0;
  cursor: pointer;
}

.list-item {
  display: flex;
  align-items: center;
  background: #1a2438;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
}

.list-info {
  flex: 1;
  cursor: pointer;
}

.list-name {
  font-weight: bold;
  font-size: 15px;
}

.list-id {
  font-size: 12px;
  color: #b8c0ff;
  margin-top: 4px;
}

.scroll-box {
  max-height: 280px;
  overflow-y: auto;
}
</style>
</head>

<body>

<div class="overlay">
  <div class="modal" id="app"></div>
</div>

<canvas id="canvas" hidden></canvas>

<script>
const app = document.getElementById("app");
let cameraScanner = null;
let pendingStudent = null;

function today() {
  return new Date().toISOString().split("T")[0];
}

/* ---------- LOCAL STORAGE HELPERS ---------- */
function getStudents() {
  const data = localStorage.getItem("studentsData");
  return data ? JSON.parse(data) : [];
}

function saveStudents(arr) {
  localStorage.setItem("studentsData", JSON.stringify(arr));
}

/* ---------- INIT ---------- */
const savedStudents = getStudents();
savedStudents.length > 0 ? showCollection() : showRegister();

/* ---------- REGISTER PAGE ---------- */
function showRegister() {
  stopCamera();
  pendingStudent = null;

  app.innerHTML = `
    <div class="header">
        Register New
        ${getStudents().length > 0 ? `<span class="close" style="float:right" onclick="showCollection()">✕</span>` : ''}
    </div>

    <input type="text" id="manualInput" placeholder="Enter student number">

    <div class="divider">OR</div>

    <div class="row">
      <button class="primary" onclick="openCamera()">Scan QR</button>
      <button class="secondary" onclick="openFile()">Choose File</button>
    </div>

    <button class="tirnery" onclick="manualPreview()">Preview</button>
  `;
}

/* ---------- PREVIEW ---------- */
function showPreview(studentNo) {
  pendingStudent = studentNo;

  app.innerHTML = `
    <div class="header">
      Confirm
      <span class="close" style="float:right" onclick="showRegister()">✕</span>
    </div>

    <div class="center" style="margin-bottom: 16px;">
      Student Number<br><b>${studentNo}</b>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="saveCheck" onchange="toggleNameInput()">
      <label for="saveCheck">Save to collection</label>
    </div>

    <input type="text" id="studentName" placeholder="Enter student name" style="display: none;">

    <div style="margin-top:16px">
      <button class="primary" onclick="processRegistration()">Confirm & Show QR</button>
      <button class="secondary" style="margin-top:8px" onclick="showRegister()">Cancel</button>
    </div>
  `;
}

function toggleNameInput() {
  const isChecked = document.getElementById("saveCheck").checked;
  document.getElementById("studentName").style.display = isChecked ? "block" : "none";
}

/* ---------- REGISTRATION LOGIC ---------- */
function processRegistration() {
  const isChecked = document.getElementById("saveCheck").checked;
  
  if (isChecked) {
    const nameVal = document.getElementById("studentName").value.trim();
    if (!nameVal) {
      alert("Please enter a student name to save to the collection.");
      return;
    }
    
    const students = getStudents();
    // Avoid exact duplicates
    if (!students.some(s => s.id === pendingStudent)) {
        students.push({ name: nameVal, id: pendingStudent });
        saveStudents(students);
    }
  }

  showQR(pendingStudent);
}

/* ---------- COLLECTION PAGE (Replaces Unregister Page) ---------- */
function showCollection() {
  stopCamera();
  const students = getStudents();

  if (students.length === 0) {
    showRegister();
    return;
  }

  let listHTML = students.map((s, index) => `
    <div class="list-item">
      <div class="list-info" onclick="showQR('${s.id}')">
        <div class="list-name">${s.name}</div>
        <div class="list-id">${s.id}</div>
      </div>
      <button class="danger" style="width: auto; padding: 8px 14px;" onclick="deleteStudent(${index})">Delete</button>
    </div>
  `).join("");

  app.innerHTML = `
    <div class="header">
      Saved Students
      <span class="close" style="float:right; font-weight:bold;" onclick="showRegister()">+ Add</span>
    </div>
    
    <div class="scroll-box">
      ${listHTML}
    </div>
  `;
}

function deleteStudent(index) {
  if (confirm("Remove this student from your collection?")) {
    const students = getStudents();
    students.splice(index, 1);
    saveStudents(students);
    showCollection();
  }
}

/* ---------- QR DISPLAY ---------- */
function showQR(studentNo) {
  stopCamera();

  app.innerHTML = `
    <div class="header">
      Generated QR
      <span class="close" style="float:right" onclick="backToMain()">✕</span>
    </div>

    <div class="qr-box"><div id="qrcode"></div></div>
    <div class="qr-text">${studentNo}/${today()}/student</div>
  `;

  new QRCode(document.getElementById("qrcode"), {
    text: `${studentNo}/${today()}/student`,
    width: 200,
    height: 200
  });
}

function backToMain() {
    const students = getStudents();
    if (students.length > 0) {
        showCollection();
    } else {
        showRegister();
    }
}

/* ---------- CAMERA ---------- */
function openCamera() {
  stopCamera();

  app.innerHTML = `
    <div class="header">
      Scan QR
      <span class="close" style="float:right" onclick="showRegister()">✕</span>
    </div>
    <div id="reader"></div>
  `;

  cameraScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams => {
    cameraScanner.start(
      cams[0].id,
      { fps: 10, qrbox: 220 },
      txt => {
        stopCamera();
        showPreview(txt.split("/")[0]);
      }
    );
  }).catch(() => alert("Camera permission denied."));
}

/* ---------- FILE SCANNER ---------- */
function openFile() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = () => scanImage(input.files[0]);
  input.click();
}

function scanImage(file) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const qr = jsQR(data.data, canvas.width, canvas.height);

    if (!qr) return alert("QR not detected in image.");
    showPreview(qr.data.split("/")[0]);
  };
  img.src = URL.createObjectURL(file);
}

/* ---------- MANUAL INPUT ---------- */
function manualPreview() {
  const v = document.getElementById("manualInput").value.trim();
  if (!v) return alert("Enter student number");
  showPreview(v);
}

/* ---------- CLEANUP ---------- */
function stopCamera() {
  if (cameraScanner) {
    cameraScanner.stop().catch(()=>{});
    cameraScanner = null;
  }
}
</script>

</body>
</html>
