<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Student QR</title>

<!-- QR Generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Camera QR -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Image QR Decoder -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  height: 100vh;
  background: #0b1220;
  font-family: system-ui;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal {
  width: 92%;
  max-width: 360px;
  background: linear-gradient(180deg,#0f1a2e,#0c1424);
  border-radius: 16px;
  padding: 18px;
  color: white;
}

.header {
  font-size: 18px;
  margin-bottom: 14px;
}

.close {
  cursor: pointer;
  font-size: 20px;
}

input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  margin-bottom: 12px;
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  cursor: pointer;
}

.primary {
  background: #3a6cff;
  color: white;
}

.secondary {
  background: #2a2f45;
  color: white;
}

.tirnery {
  background: #5c4bde;
  color: white;
}

.danger {
  background: #ff5c5c;
  color: white;
}

.divider {
  text-align: center;
  color: #7f89c9;
  font-size: 13px;
  margin: 10px 0;
}

.row {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

.row button {
  flex: 1;
}

.center {
  text-align: center;
}

.qr-box {
  background: white;
  padding: 16px;
  border-radius: 10px;
  display: flex;
  justify-content: center;
}

.qr-text {
  text-align: center;
  margin-top: 10px;
  font-size: 13px;
  color: #b8c0ff;
}
</style>
</head>

<body>

<div class="overlay">
  <div class="modal" id="app"></div>
</div>

<canvas id="canvas" hidden></canvas>

<script>
const app = document.getElementById("app");
let cameraScanner = null;
let pendingStudent = null;

function today() {
  return new Date().toISOString().split("T")[0];
}

/* ---------- INIT ---------- */
const saved = localStorage.getItem("studentNumber");
saved ? showQR(saved) : showRegister();

/* ---------- REGISTER PAGE (FIXED UI) ---------- */
function showRegister() {
  stopCamera();
  pendingStudent = null;

  app.innerHTML = `
    <div class="header">Register</div>

    <input id="manualInput" placeholder="Enter student number">

    <div class="divider">OR</div>

    <div class="row">
      <button class="primary" onclick="openCamera()">Scan QR</button>
      <button class="secondary" onclick="openFile()">Choose File</button>
    </div>

    <button class="tirnery" onclick="manualPreview()">Preview</button>
  `;
}

/* ---------- PREVIEW ---------- */
function showPreview(studentNo) {
  pendingStudent = studentNo;

  app.innerHTML = `
    <div class="header">
      Confirm
      <span class="close" style="float:right" onclick="showRegister()">✕</span>
    </div>

    <div class="center">
      Student Number<br><b>${studentNo}</b>
    </div>

    <div style="margin-top:16px">
      <button class="primary" onclick="register()">Register</button>
      <button class="secondary" style="margin-top:8px" onclick="showRegister()">Cancel</button>
    </div>
  `;
}

/* ---------- REGISTER ---------- */
function register() {
  localStorage.setItem("studentNumber", pendingStudent);
  showQR(pendingStudent);
}

/* ---------- QR DISPLAY ---------- */
function showQR(studentNo) {
  stopCamera();

  app.innerHTML = `
    <div class="header">
      QRCode
      <span class="close" style="float:right" onclick="confirmUnregister()">✕</span>
    </div>

    <div class="qr-box"><div id="qrcode"></div></div>
    <div class="qr-text">${studentNo}/${today()}/student</div>
  `;

  new QRCode(document.getElementById("qrcode"), {
    text: `${studentNo}/${today()}/student`,
    width: 200,
    height: 200
  });
}

/* ---------- UNREGISTER ---------- */
function confirmUnregister() {
  app.innerHTML = `
    <div class="header">Unregister</div>

    <div class="center">Do you want to unregister your QR?</div>

    <div style="margin-top:16px">
      <button class="danger" onclick="unregister()">Unregister</button>
      <button class="secondary" style="margin-top:8px"
        onclick="showQR(localStorage.getItem('studentNumber'))">Cancel</button>
    </div>
  `;
}

function unregister() {
  localStorage.removeItem("studentNumber");
  showRegister();
}

/* ---------- CAMERA ---------- */
function openCamera() {
  stopCamera();

  app.innerHTML = `
    <div class="header">
      Scan QR
      <span class="close" style="float:right" onclick="showRegister()">✕</span>
    </div>
    <div id="reader"></div>
  `;

  cameraScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams => {
    cameraScanner.start(
      cams[0].id,
      { fps: 10, qrbox: 220 },
      txt => {
        stopCamera();
        showPreview(txt.split("/")[0]);
      }
    );
  }).catch(() => alert("Camera permission denied"));
}

/* ---------- FILE ---------- */
function openFile() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = () => scanImage(input.files[0]);
  input.click();
}

function scanImage(file) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const qr = jsQR(data.data, canvas.width, canvas.height);

    if (!qr) return alert("QR not detected");
    showPreview(qr.data.split("/")[0]);
  };
  img.src = URL.createObjectURL(file);
}

/* ---------- MANUAL ---------- */
function manualPreview() {
  const v = document.getElementById("manualInput").value.trim();
  if (!v) return alert("Enter student number");
  showPreview(v);
}

/* ---------- CLEANUP ---------- */
function stopCamera() {
  if (cameraScanner) {
    cameraScanner.stop().catch(()=>{});
    cameraScanner = null;
  }
}
</script>

</body>
</html>
